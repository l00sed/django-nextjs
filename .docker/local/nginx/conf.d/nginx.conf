# Default Docker network resolver
resolver 127.0.0.11;

# Setup frontend requests to use port 3000
upstream frontend {
  server frontend:3000;
}

# Setup backend requests to use port 8000
upstream backend {
  server backend:8000;
}

server {
  listen 80;
  listen [::]:80;

  # Redirect www, 80 by default
  server_name www.loosed.local;
  return 301 https://loosed.local$request_uri;
}

# Main server directive
server {
  http2               on;

  listen 443          default ssl;
  listen [::]:443     default ssl;

  ssl_certificate     /etc/nginx/certs/loosed.test.crt;
  ssl_certificate_key /etc/nginx/certs/loosed.test.key;

  root                /app;
  server_name         loosed.local;

  # add_header X-XSS-Protection "1; mode=block";
  # add_header X-Content-Type-Options "nosniff";

  charset utf-8;

  gzip on;
  gzip_disable "msie6";
  gzip_comp_level 6;
  gzip_min_length 1100;
  gzip_buffers 16 8k;
  gzip_proxied any;
  gzip_types
    text/plain
    text/css
    text/js
    text/xml
    text/javascript
    application/javascript
    application/json
    application/xml
    application/rss+xml
    image/svg+xml;

  location / {
    proxy_pass       http://frontend;

    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location ~ ^/favicon(.*)$ {
    root              /app/frontend/public/assets/favicon/;
    proxy_pass        http://frontend;

    proxy_redirect    off;
    proxy_set_header   Host $http_host;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-NginX-Proxy true;
    proxy_set_header   X-Real-IP $remote_addr;
  }

  location ~ ^/_next/(.*)$ {
    root               /app/frontend/.next/;
    proxy_pass         http://frontend;

    proxy_http_version 1.1;  # Websockets
    proxy_redirect     off;
    proxy_set_header   Connection "upgrade";  # Websockets
    proxy_set_header   Host $http_host;
    proxy_set_header   Upgrade $http_upgrade;  # Websockets
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-NginX-Proxy true;
    proxy_set_header   X-Real-IP $remote_addr;
  }

  location /swagger {
    proxy_pass       http://backend;

    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /admin {
    proxy_pass       http://backend;

    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /api {
    proxy_pass       http://backend;

    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /webmention {
    proxy_pass       http://backend;

    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /sitemap.xml {
    proxy_pass       http://backend;

    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /static/ {
    proxy_pass       http://backend;

    alias            /app/backend/static/;
    autoindex        on;
    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /uploads/ {
    proxy_pass       http://backend;

    alias            /app/backend/uploads/;
    autoindex        on;
    proxy_redirect   off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location ~* .(svg|otf|woff|woff2|mp4|ttf|css|rss|atom|js|jpg|jpeg|gif|png|ico|bmp)$ {
    access_log       off;
    expires          max;
    log_not_found    off;
  }

  # error_page 404 /404;
  # error_page 500 502 503 504 /500;
}
